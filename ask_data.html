{% extends "base.html" %}
{% block title %}Ask Your Data - Market Lens AI{% endblock %}
{% block content %}
<style>

    /* ── Page layout ── */
    .ask-wrapper {
        max-width: 960px;
        margin: 0 auto;
    }

    /* ── Hero — matches index.html style ── */
    .ask-hero {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
        padding: 0 2.5rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        min-height: 140px;
        position: relative;
        overflow: hidden;
    }

    .ask-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
        background-size: 32px 32px;
        border-radius: inherit;
        pointer-events: none;
    }

    .ask-hero::after {
        content: '';
        position: absolute;
        right: -60px; top: -60px;
        width: 240px; height: 240px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 65%);
        pointer-events: none;
    }

    .ask-hero-left {
        position: relative;
        z-index: 1;
    }

    .ask-hero-left h1 {
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0 0 6px 0;
        letter-spacing: -0.02em;
        line-height: 1.15;
    }

    .ask-hero-left p {
        font-size: 1rem;
        opacity: 0.8;
        font-weight: 400;
        margin: 0;
    }

    .ask-hero-right {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        position: relative;
        z-index: 1;
        flex-shrink: 0;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .hero-pill {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        background: rgba(255,255,255,0.12);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 999px;
        padding: 0.45rem 1rem;
        font-size: 0.82rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .hero-pill i { font-size: 0.74rem; opacity: 0.85; }

    /* ── Two column layout ── */
    .ask-grid {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 1.5rem;
        align-items: start;
    }

    /* ── Main query card ── */
    .query-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: var(--shadow-card);
    }

    /* ── AI badge ── */
    .ai-badge {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        background: var(--bg-nav-active);
        border: 1px solid rgba(37,99,235,0.2);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
    }

    .ai-badge i { color: #2563eb; font-size: 1rem; flex-shrink: 0; }
    .ai-badge span { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; }
    .ai-badge strong { color: var(--text-primary); }

    /* ── Label ── */
    .field-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.6rem;
    }

    /* ── Auto-grow textarea ── */
    .query-textarea {
        width: 100%;
        background: var(--bg-user-info);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: 'Inter', sans-serif;
        resize: none;
        overflow: hidden;
        line-height: 1.6;
        min-height: 48px;
        max-height: 280px;
        overflow-y: auto;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .query-textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        background: var(--bg-user-info-hover);
    }

    .query-textarea::placeholder { color: var(--text-muted); }

    .input-hint {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-top: 0.5rem;
        font-size: 0.78rem;
        color: var(--text-muted);
    }

    /* ── Submit button ── */
    .submit-btn {
        background: #2563eb;
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        width: 100%;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: background 0.2s;
        font-family: 'Inter', sans-serif;
    }

    .submit-btn:hover:not(:disabled) { background: #1d4ed8; }
    .submit-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    /* ── Loading ── */
    .loading-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 0 0.25rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .spinner {
        width: 20px; height: 20px;
        border: 2px solid var(--border);
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: spin 0.75s linear infinite;
        flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Response ── */
    .response-card {
        background: var(--bg-nav-active);
        border: 1px solid rgba(37,99,235,0.18);
        border-radius: 10px;
        padding: 1.25rem;
        margin-top: 1.25rem;
    }

    .response-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: #2563eb;
        margin-bottom: 0.75rem;
    }

    .response-content {
        font-size: 0.92rem;
        line-height: 1.75;
        color: var(--text-primary);
    }

    .response-content p { margin: 0 0 0.6rem 0; }
    .response-content p:last-child { margin-bottom: 0; }

    .secondary-btn {
        margin-top: 1rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
    }

    .secondary-btn:hover {
        border-color: #2563eb;
        color: #2563eb;
        background: var(--bg-nav-active);
    }

    /* ── Error ── */
    .error-card {
        background: rgba(239,68,68,0.05);
        border: 1px solid rgba(239,68,68,0.2);
        border-radius: 10px;
        padding: 1.25rem;
        margin-top: 1.25rem;
    }

    .error-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: #dc2626;
        margin-bottom: 0.6rem;
    }

    .error-content {
        font-size: 0.88rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    /* ── Sidebar cards ── */
    .sidebar-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        box-shadow: var(--shadow-card);
        margin-bottom: 1rem;
    }

    .sidebar-card:last-child { margin-bottom: 0; }

    .sidebar-card-title {
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: var(--text-muted);
        margin-bottom: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .example-item {
        display: flex;
        align-items: flex-start;
        gap: 0.6rem;
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 0.45rem;
        cursor: pointer;
        transition: all 0.15s;
        background: var(--bg-user-info);
    }

    .example-item:last-child { margin-bottom: 0; }

    .example-item:hover {
        border-color: #2563eb;
        background: var(--bg-nav-active);
        transform: translateX(3px);
    }

    .example-item i { color: #2563eb; font-size: 0.68rem; margin-top: 4px; flex-shrink: 0; }
    .example-item span { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.4; }
    .example-item:hover span { color: var(--text-primary); }

    .tip-row {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.45rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .tip-row:last-child { margin-bottom: 0; }
    .tip-row i { color: #2563eb; font-size: 0.68rem; margin-top: 3px; flex-shrink: 0; }

    /* ── Inline examples (inside query card) ── */
    .examples-inline {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .examples-inline-title {
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        color: var(--text-muted);
        margin-bottom: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .examples-inline-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    @media (max-width: 600px) {
        .examples-inline-grid { grid-template-columns: 1fr; }
    }

    .d-none { display: none !important; }

    @media (max-width: 860px) {
        .ask-hero {
            flex-direction: column;
            align-items: flex-start;
            padding: 1.25rem 1.5rem;
            min-height: unset;
            gap: 0.75rem;
        }
        .ask-hero-right { flex-wrap: wrap; }
        .ask-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="ask-wrapper">

    <!-- Hero -->
    <div class="ask-hero">
        <div class="ask-hero-left">
            <h1>Ask Your Data</h1>
            <p>Get instant AI-powered answers from your customer data</p>
        </div>
        <div class="ask-hero-right">
            <div class="hero-pill"><i class="fas fa-brain"></i> Mistral AI</div>
            <div class="hero-pill"><i class="fas fa-bolt"></i> Natural Language</div>
            <div class="hero-pill"><i class="fas fa-database"></i> Live Data</div>
        </div>
    </div>

    <div class="ask-grid">

        <!-- Left: main input card -->
        <div class="query-card">
            <div class="ai-badge">
                <i class="fas fa-robot"></i>
                <span><strong>Powered by Mistral AI</strong> — Ask questions in plain English and get insights from your uploaded dataset instantly.</span>
            </div>

            <label for="queryInput" class="field-label">Your Question</label>
            <textarea
                id="queryInput"
                class="query-textarea"
                rows="1"
                placeholder="e.g. What is the average spending score?"></textarea>
            <div class="input-hint">
                <i class="fas fa-keyboard"></i> Press Ctrl+Enter to submit
            </div>

            <button id="submitBtn" class="submit-btn" onclick="submitQuery()">
                <i class="fas fa-paper-plane"></i> Send Query
            </button>

            <div id="loadingSpinner" class="loading-row d-none">
                <div class="spinner"></div>
                <span>AI is analysing your data...</span>
            </div>

            <div id="responseArea" class="d-none">
                <div class="response-card">
                    <div class="response-label"><i class="fas fa-lightbulb"></i> AI Response</div>
                    <div id="responseContent" class="response-content"></div>
                </div>
                <button class="secondary-btn" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Ask Another Question
                </button>
            </div>

            <div id="errorArea" class="d-none">
                <div class="error-card">
                    <div class="error-label"><i class="fas fa-exclamation-circle"></i> Error</div>
                    <div id="errorContent" class="error-content"></div>
                </div>
                <button class="secondary-btn" onclick="resetForm()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>

            <!-- Example Queries — below send button -->
            <div class="examples-inline">
                <div class="examples-inline-title"><i class="fas fa-list"></i> Example Queries</div>
                <div class="examples-inline-grid">
                    <div class="example-item" onclick="setQuery('What is the average spending score?')">
                        <i class="fas fa-chevron-right"></i><span>What is the average spending score?</span>
                    </div>
                    <div class="example-item" onclick="setQuery('Show me the top 5 customers by annual income')">
                        <i class="fas fa-chevron-right"></i><span>Show me the top 5 customers by annual income</span>
                    </div>
                    <div class="example-item" onclick="setQuery('How many unique regions are there?')">
                        <i class="fas fa-chevron-right"></i><span>How many unique regions are there?</span>
                    </div>
                    <div class="example-item" onclick="setQuery('What is the correlation between spending score and annual income?')">
                        <i class="fas fa-chevron-right"></i><span>Correlation between spending score and annual income?</span>
                    </div>
                    <div class="example-item" onclick="setQuery('Create a summary of customer demographics')">
                        <i class="fas fa-chevron-right"></i><span>Create a summary of customer demographics</span>
                    </div>
                    <div class="example-item" onclick="setQuery('Which customer segment has the highest churn risk?')">
                        <i class="fas fa-chevron-right"></i><span>Which segment has the highest churn risk?</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: sidebar — Tips only -->
        <div>
            <div class="sidebar-card">
                <div class="sidebar-card-title"><i class="fas fa-lightbulb"></i> Tips</div>
                <div class="tip-row"><i class="fas fa-check-circle"></i><span>Be specific — mention column names like <strong>Spending_Score</strong></span></div>
                <div class="tip-row"><i class="fas fa-check-circle"></i><span>Ask for comparisons, averages, or top N results</span></div>
                <div class="tip-row"><i class="fas fa-check-circle"></i><span>Click any example query to auto-fill</span></div>
                <div class="tip-row"><i class="fas fa-check-circle"></i><span>Use Ctrl+Enter to submit quickly</span></div>
            </div>
        </div>

    </div>
</div>

<script>
function setQuery(query) {
    const ta = document.getElementById('queryInput');
    ta.value = query;
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 280) + 'px';
    ta.focus();
}

function submitQuery() {
    const query = document.getElementById('queryInput').value.trim();
    if (!query) { document.getElementById('queryInput').focus(); return; }

    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('responseArea').classList.add('d-none');
    document.getElementById('errorArea').classList.add('d-none');
    document.getElementById('submitBtn').disabled = true;

    fetch('/ask_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('submitBtn').disabled = false;
        if (data.error) {
            document.getElementById('errorContent').textContent = data.error;
            document.getElementById('errorArea').classList.remove('d-none');
        } else {
            document.getElementById('responseContent').innerHTML = formatAIResponse(data.result);
            document.getElementById('responseArea').classList.remove('d-none');
            const ta = document.getElementById('queryInput');
            ta.value = '';
            ta.style.height = '48px';
        }
    })
    .catch(err => {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('errorContent').textContent = err.message;
        document.getElementById('errorArea').classList.remove('d-none');
    });
}

function formatAIResponse(text) {
    const escape = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    let f = escape(text);
    f = f.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');
    return '<p>' + f + '</p>';
}

function resetForm() {
    const ta = document.getElementById('queryInput');
    ta.value = '';
    ta.style.height = '48px';
    document.getElementById('responseArea').classList.add('d-none');
    document.getElementById('errorArea').classList.add('d-none');
    ta.focus();
}

document.getElementById('queryInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 280) + 'px';
});

document.getElementById('queryInput').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitQuery();
});

window.addEventListener('load', () => document.getElementById('queryInput').focus());
</script>
{% endblock %}
