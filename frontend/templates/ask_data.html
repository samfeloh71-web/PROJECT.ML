{% extends "base.html" %}

{% block title %}Ask Your Data - Market Lens AI{% endblock %}

{% block content %}
<style>
    .ask-data-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #ffffff, #a5b4fc);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.75rem;
        letter-spacing: -0.02em;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 400;
    }

    .query-card {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        padding: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .query-card:hover {
        border-color: rgba(99, 102, 241, 0.3);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .info-badge {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .info-badge i {
        font-size: 1.5rem;
        color: #6366f1;
    }

    .info-badge-text {
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .form-label {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    .query-textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        color: rgba(255, 255, 255, 0.95);
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        resize: vertical;
        transition: all 0.3s ease;
        line-height: 1.6;
    }

    .query-textarea:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(99, 102, 241, 0.5);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .query-textarea::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .textarea-hint {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .submit-btn {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        color: white;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(99, 102, 241, 0.5);
        background: linear-gradient(135deg, #7c3aed, #a855f7);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(99, 102, 241, 0.2);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
    }

    .response-card {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
    }

    .response-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .response-header i {
        font-size: 1.5rem;
        color: #fbbf24;
    }

    .response-header h5 {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: #ffffff;
        margin: 0;
    }

    .response-content {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        color: rgba(255, 255, 255, 0.95);
        /* CHANGED: Professional font instead of monospace */
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 1rem;
        line-height: 1.8;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Style for better text readability */
    .response-content p {
        margin-bottom: 1rem;
    }

    .response-content strong {
        color: #ffffff;
        font-weight: 600;
    }

    .error-card {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 16px;
        padding: 2rem;
        margin-top: 2rem;
    }

    .error-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .error-header i {
        font-size: 1.5rem;
        color: #ef4444;
    }

    .error-header h5 {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: #ffffff;
        margin: 0;
    }

    .error-content {
        color: rgba(255, 255, 255, 0.85);
        font-size: 1rem;
        line-height: 1.6;
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .examples-card {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 2rem;
    }

    .examples-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .examples-title i {
        color: #6366f1;
    }

    .example-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

    .example-item:hover {
        background: rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.3);
        transform: translateX(5px);
        color: #ffffff;
    }

    .example-item:last-child {
        margin-bottom: 0;
    }

    .d-none {
        display: none !important;
    }

    @media (max-width: 768px) {
        .ask-data-container {
            padding: 2rem 1rem;
        }

        .page-title {
            font-size: 2rem;
        }

        .query-card {
            padding: 1.5rem;
        }
    }
</style>

<div class="ask-data-container">
    <div class="page-header">
        <h1 class="page-title">ðŸ’¬ Ask Your Data</h1>
        <p class="page-subtitle">Get AI-powered insights from your data using natural language</p>
    </div>

    <div class="query-card">
        <div class="info-badge">
            <i class="fas fa-brain"></i>
            <div class="info-badge-text">
                <strong>Powered by Mistral AI:</strong> Ask natural language questions about your data. The AI will analyze and provide insights in a friendly, professional manner.
            </div>
        </div>

        <!-- Query Input Area -->
        <div class="mb-4">
            <label for="queryInput" class="form-label">Your Question:</label>
            <textarea 
                id="queryInput" 
                class="query-textarea" 
                rows="6" 
                placeholder="Examples:&#10;â€¢ What is the average spending score?&#10;â€¢ Show me the top 5 customers by annual income&#10;â€¢ How many unique regions are there?&#10;â€¢ Filter customers with spending score above 70&#10;â€¢ What is the correlation between spending score and annual income?"></textarea>
            <small class="textarea-hint">
                <i class="fas fa-info-circle"></i> Press Ctrl+Enter to submit your query
            </small>
        </div>

        <!-- Send Button -->
        <button 
            id="submitBtn" 
            class="submit-btn"
            onclick="submitQuery()">
            <i class="fas fa-paper-plane"></i>
            <span>Send Query</span>
        </button>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner d-none">
            <div class="spinner"></div>
            <p class="loading-text">AI is analyzing your data...</p>
        </div>

        <!-- Response Area -->
        <div id="responseArea" class="d-none">
            <div class="response-card">
                <div class="response-header">
                    <i class="fas fa-lightbulb"></i>
                    <h5>AI Response</h5>
                </div>
                <div id="responseContent" class="response-content">
                    <!-- Response will be inserted here -->
                </div>
                <button class="action-btn" onclick="resetForm()">
                    <i class="fas fa-redo me-2"></i>Ask Another Question
                </button>
            </div>
        </div>

        <!-- Error Area -->
        <div id="errorArea" class="d-none">
            <div class="error-card">
                <div class="error-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h5>Error</h5>
                </div>
                <div id="errorContent" class="error-content">
                    <!-- Error will be inserted here -->
                </div>
                <button class="action-btn" onclick="resetForm()">
                    <i class="fas fa-redo me-2"></i>Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Example Queries Section -->
    <div class="examples-card">
        <h5 class="examples-title">
            <i class="fas fa-question-circle"></i>
            Example Queries
        </h5>
        <div>
            <div class="example-item" onclick="setQuery('What is the average spending score?')">
                What is the average spending score?
            </div>
            <div class="example-item" onclick="setQuery('Show me the top 5 customers by annual income')">
                Show me the top 5 customers by annual income
            </div>
            <div class="example-item" onclick="setQuery('How many unique regions are there?')">
                How many unique regions are there?
            </div>
            <div class="example-item" onclick="setQuery('What is the correlation between spending score and annual income?')">
                What is the correlation between spending score and annual income?
            </div>
            <div class="example-item" onclick="setQuery('Create a summary of customer demographics')">
                Create a summary of customer demographics
            </div>
        </div>
    </div>
</div>

<script>
function setQuery(query) {
    document.getElementById('queryInput').value = query;
    document.getElementById('queryInput').focus();
}

function submitQuery() {
    const query = document.getElementById('queryInput').value.trim();
    
    if (!query) {
        alert('Please enter a question.');
        return;
    }

    // Show loading spinner
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('responseArea').classList.add('d-none');
    document.getElementById('errorArea').classList.add('d-none');
    document.getElementById('submitBtn').disabled = true;

    // Send request to backend
    fetch('/ask_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('submitBtn').disabled = false;

        if (data.error) {
            // Show error
            document.getElementById('errorContent').textContent = data.error;
            document.getElementById('errorArea').classList.remove('d-none');
        } else {
            // Show response - format it nicely
            const formattedResponse = formatAIResponse(data.result);
            document.getElementById('responseContent').innerHTML = formattedResponse;
            document.getElementById('responseArea').classList.remove('d-none');
        }
    })
    .catch(error => {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('errorContent').textContent = error.message;
        document.getElementById('errorArea').classList.remove('d-none');
    });
}

function formatAIResponse(text) {
    // Clean up the response and make it look professional
    // Escape HTML
    const escapeHtml = (unsafe) => {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    };
    
    let formatted = escapeHtml(text);
    
    // Convert line breaks to proper HTML
    formatted = formatted.replace(/\n\n/g, '</p><p>');
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Wrap in paragraph
    formatted = '<p>' + formatted + '</p>';
    
    return formatted;
}

function resetForm() {
    document.getElementById('queryInput').value = '';
    document.getElementById('responseArea').classList.add('d-none');
    document.getElementById('errorArea').classList.add('d-none');
    document.getElementById('queryInput').focus();
}

// Allow Ctrl+Enter to submit
document.getElementById('queryInput').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        submitQuery();
    }
});

// Focus on page load
window.addEventListener('load', function() {
    document.getElementById('queryInput').focus();
});
</script>
{% endblock %}
